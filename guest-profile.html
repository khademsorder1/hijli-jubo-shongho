<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guest প্রোফাইল তৈরি করুন - হিজলী দিঘাপাড়া যুব সংঘ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <!-- Image Compression Library -->
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap');
        :root { 
            --primary-color: #16a085; 
            --secondary-color: #27ae60; 
            --dark-text: #2c3e50; 
            --light-text: #7f8c8d; 
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); 
            --error-color: #e74c3c; 
            --success-color: #27ae60;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Hind Siliguri', sans-serif; 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            padding: 20px; 
        }
        .profile-container { 
            background-color: white; 
            border-radius: 15px; 
            box-shadow: var(--card-shadow); 
            width: 100%; 
            max-width: 420px; 
            overflow: hidden;
        }
        .header {
            padding: 20px;
            text-align: center;
        }
        .header h2 {
            color: var(--dark-text);
            margin-bottom: 5px;
        }
        .header p {
            color: var(--light-text);
        }
        .main-content {
            padding: 30px;
        }
        .form-control { margin-bottom: 20px; }
        .form-control label { font-weight: 500; display: block; margin-bottom: 8px; text-align: left;}
        .form-control input { 
            width: 100%; 
            padding: 14px 20px; 
            border: 2px solid #e0e0e0; 
            background-color: #f9f9f9; 
            border-radius: 10px; 
            font-size: 1rem; 
        }
        .form-control input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .form-control input[type="file"] { 
            padding: 10px; 
            background-color: transparent; 
            border: 2px dashed #e0e0e0;
        }
        .phone-input-group { display: flex; }
        .phone-input-group .country-code { 
            padding: 14px; 
            background-color: #ecf0f1; 
            border: 2px solid #e0e0e0; 
            border-right: none; 
            border-radius: 10px 0 0 10px; 
            font-weight: 600; 
        }
        .phone-input-group input { border-radius: 0 10px 10px 0; }
        .btn { 
            width: 100%; 
            padding: 14px; 
            border: none; 
            border-radius: 10px; 
            color: white; 
            font-size: 1.1rem; 
            font-weight: 600; 
            cursor: pointer; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 8px; 
            transition: background-color 0.3s;
        }
        .btn-primary { background-color: var(--primary-color); }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .message-box { 
            text-align: center; 
            margin-top: 15px; 
            font-weight: 500; 
            display: none; 
            padding: 12px; 
            border-radius: 8px; 
        }
        .error-message { color: var(--error-color); background-color: #fadbd8; }
        .info-message { color: #2980b9; background-color: #d6eaf8; }
        .loader-small { 
            width: 20px; 
            height: 20px; 
            border: 3px solid rgba(255,255,255,0.4); 
            border-top-color: white; 
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .footer {
            text-align: center;
            padding: 20px 0 0 0;
            color: white;
            font-size: 0.9rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="profile-container">
        <div class="header">
            <h2>Guest প্রোফাইল তৈরি করুন</h2>
            <p>সংগঠনে যোগ দিতে আপনার তথ্য দিন।</p>
        </div>
        <div class="main-content">
            <form id="guest-form">
                <div class="form-control"><input type="text" id="guest-name" placeholder="আপনার পুরো নাম (আবশ্যক)" required></div>
                <div class="form-control"><input type="text" id="guest-location" placeholder="আপনার বর্তমান ঠিকানা (আবশ্যক)" required></div>
                <div class="form-control phone-input-group">
                    <span class="country-code">+880</span>
                    <input type="tel" id="guest-phone" placeholder="1xxxxxxxxx (আবশ্যক)" required>
                </div>
                <div class="form-control">
                     <label for="guest-photo">প্রোফাইল ছবি (ঐচ্ছিক)</label>
                     <input type="file" id="guest-photo" accept="image/*">
                </div>
                <button type="submit" id="submit-btn" class="btn btn-primary">প্রবেশ করুন</button>
                <div class="message-box" id="message-box"></div>
            </form>
        </div>
    </div>
    <footer class="footer">
        সর্বস্বত্ব সংরক্ষিত © ২০২৬ হিজলী দিঘাপাড়া যুব সংঘ
    </footer>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // আপনার Firebase কনফিগারেশন
            const firebaseConfig = { apiKey: "AIzaSyDerc9e0-e7WBnkK2GoinFejp7zszXJ3Jc", authDomain: "songho-8ef5c.firebaseapp.com", projectId: "songho-8ef5c", storageBucket: "songho-8ef5c.appspot.com", messagingSenderId: "489031747232", appId: "1:489031747232:web:4c1cde63dabaa620ed2bc5", measurementId: "G-5NY15E3XJJ" };
            
            // আপনার Cloudinary তথ্য
            const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dy7sxczfo/image/upload';
            const CLOUDINARY_UPLOAD_PRESET = 'songho_preset';

            const guestForm = document.getElementById('guest-form');
            const nameInput = document.getElementById('guest-name');
            const locationInput = document.getElementById('guest-location');
            const phoneInput = document.getElementById('guest-phone');
            const photoInput = document.getElementById('guest-photo');
            const submitBtn = document.getElementById('submit-btn');
            const messageBox = document.getElementById('message-box');

            try {
                const app = firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const db = firebase.firestore();

                guestForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    toggleLoading(true);
                    showMessage('');
                    
                    const phone = phoneInput.value.trim();
                    if (!/^[1][3-9]\d{8}$/.test(phone)) {
                        showMessage("অনুগ্রহ করে একটি সঠিক ১১ ডিজিটের ফোন নম্বর দিন (0 ছাড়া)।", 'error');
                        toggleLoading(false);
                        return;
                    }
                    
                    const fullPhoneNumber = `+880${phone}`;

                    try {
                        const q = db.collection('members').where('phone', '==', fullPhoneNumber).where('isGuest', '==', true);
                        const querySnapshot = await q.get();

                        if (!querySnapshot.empty) {
                            // Guest exists, sign in anonymously and redirect
                            const existingGuestUID = querySnapshot.docs[0].id;
                            localStorage.setItem('guestUID', existingGuestUID);
                            await auth.signInAnonymously();
                            // onAuthStateChanged in user.html will handle the rest
                            window.location.replace('user.html');
                        } else {
                            // New guest, create profile
                            const userCredential = await auth.signInAnonymously();
                            const user = userCredential.user;
                            
                            let imageUrl = '';
                            const file = photoInput.files[0];
                            if (file) {
                                showMessage("ছবি কম্প্রেস ও আপলোড করা হচ্ছে...", "info");
                                const options = { maxSizeMB: 0.5, maxWidthOrHeight: 800, useWebWorker: true };
                                const compressedFile = await imageCompression(file, options);
                                
                                const formData = new FormData();
                                formData.append('file', compressedFile);
                                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                                
                                const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                                if (!response.ok) throw new Error('Image upload failed');
                                const data = await response.json();
                                imageUrl = data.secure_url;
                            }

                            await db.collection('members').doc(user.uid).set({
                                name: nameInput.value,
                                location: locationInput.value,
                                phone: fullPhoneNumber,
                                img: imageUrl,
                                isGuest: true,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            localStorage.setItem('guestUID', user.uid);
                            window.location.replace('user.html');
                        }
                    } catch (error) {
                        console.error("Guest profile creation/login failed:", error);
                        showMessage("প্রোফাইল তৈরি বা লগইন করতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।");
                        toggleLoading(false);
                    }
                });
                
                function showMessage(msg, type = 'error') {
                    messageBox.textContent = msg;
                    messageBox.className = `message-box ${type}-message`;
                    messageBox.style.display = msg ? 'block' : 'none';
                }

                function toggleLoading(isLoading) {
                    submitBtn.disabled = isLoading;
                    submitBtn.innerHTML = isLoading ? '<div class="loader-small"></div>' : 'প্রবেশ করুন';
                }

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                document.body.innerHTML = 'Error initializing system. Please contact the administrator.';
            }
        });
    </script>
</body>
</html>