<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>হিজলী দিঘাপাড়া যুব সংঘ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        /* CSS কোড লোড হওয়ার আগে বডি হাইড রাখা হয়, যা ফ্ল্যাশিং রোধ করে */
        body { display: none; } 
        :root { --primary-color: #16a085; --secondary-color: #e74c3c; --light-gray: #f0f2f5; --dark-text: #2c3e50; --light-text: #666; --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); --error-color: #e74c3c; }
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap');
        body { font-family: 'Hind Siliguri', sans-serif; margin: 0; background-color: var(--light-gray); color: var(--dark-text); padding-bottom: 80px; }
        header { background-color: var(--primary-color); color: white; padding: 20px; text-align: center; }
        header h1 { font-size: 1.6rem; margin: 0; }
        .page { display: none; padding: 15px; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background-color: white; padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); margin-bottom: 20px; }
        h2 { font-size: 1.4rem; text-align: center; margin-bottom: 20px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background-color: white; box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-around; padding: 8px 0; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #95a5a6; font-size: 0.8rem; padding: 5px; cursor: pointer; flex-grow: 1; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary-color); }
        .data-list .data-item { padding: 10px; border-bottom: 1px solid #eee; }
        .error-message { color: var(--error-color); font-weight: 500; text-align: center; padding: 10px; background: #fdd; border: 1px solid var(--error-color); border-radius: 5px; }
    </style>
</head>
<body>
    <header><h1>হিজলী দিঘাপাড়া যুব সংঘ</h1></header>
    <main>
        <div id="home-section" class="page">
            <div class="card"><h2>হোম</h2><div id="homeNoticeBoard" class="data-list"><p>লোড হচ্ছে...</p></div></div>
        </div>
        <div id="member-section" class="page">
            <div class="card"><h2>সদস্য তালিকা</h2><div id="memberList" class="data-list"><p>লোড হচ্ছে...</p></div></div>
        </div>
        <div id="donation-section" class="page">
             <div class="card"><h2>ডোনেশন তালিকা</h2><div id="donationList" class="data-list"><p>লোড হচ্ছে...</p></div></div>
        </div>
        <div id="finance-section" class="page">
            <div class="card"><h2>আয়-ব্যয় হিসাব</h2><div id="finance-summary"><p>লোড হচ্ছে...</p></div></div>
        </div>
        <div id="blood-section" class="page">
             <div class="card"><h2>রক্তদাতার তালিকা</h2><div id="bloodList" class="data-list"><p>লোড হচ্ছে...</p></div></div>
        </div>
        <div id="profile-section" class="page">
            <div class="card"><h2>আমার প্রোফাইল</h2><div id="myProfile"><p>লোড হচ্ছে...</p></div></div>
            <div class="card"><h3>আমার ডোনেশন হিস্ট্রি</h3><div id="myDonationHistory" class="data-list"><p>লোড হচ্ছে...</p></div></div>
        </div>
    </main>
    
    <nav class="bottom-nav">
        <div class="nav-item active" data-page="home-section"><i class="fas fa-home"></i><span>হোম</span></div>
        <div class="nav-item" data-page="member-section"><i class="fas fa-users"></i><span>সদস্য</span></div>
        <div class="nav-item" data-page="donation-section"><i class="fas fa-hand-holding-heart"></i><span>ডোনেশন</span></div>
        <div class="nav-item" data-page="finance-section"><i class="fas fa-calculator"></i><span>হিসাব</span></div>
        <div class="nav-item" data-page="blood-section"><i class="fas fa-heart"></i><span>রক্ত</span></div>
        <div class="nav-item" data-page="profile-section" id="profileNavButton"><i class="fas fa-user-circle"></i><span>প্রোফাইল</span></div>
        <div class="nav-item" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>লগআউট</span></div>
    </nav>
    
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // আপনার Firebase কনফিগারেশন
    const firebaseConfig = {
        apiKey: "AIzaSyDerc9e0-e7WBnkK2GoinFejp7zszXJ3Jc", authDomain: "songho-8ef5c.firebaseapp.com", projectId: "songho-8ef5c", storageBucket: "songho-8ef5c.appspot.com", messagingSenderId: "489031747232", appId: "1:489031747232:web:4c1cde63dabaa620ed2bc5", measurementId: "G-5NY15E3XJJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Helper Functions ---
    const showError = (element, message) => {
        element.innerHTML = `<div class="error-message">${message}</div>`;
        console.error(message);
    };

    // --- Authentication ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // User is signed in.
            document.body.style.display = 'block'; // Show the page content
            initializeApp(user);
        } else {
            // No user is signed in. Redirect to login page.
            window.location.replace('index.html');
        }
    });

    function initializeApp(user) {
        // Setup navigation
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            if (item.dataset.page) {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    document.getElementById(item.dataset.page).classList.add('active');
                    navItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                });
            }
        });

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
        
        // Hide profile for guests
        if (user.isAnonymous) {
            document.getElementById('profileNavButton').style.display = 'none';
        }

        // Load initial data
        showPage('home-section');
        loadAllData(user);
    }
    
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(nav => {
            nav.classList.remove('active');
            if (nav.dataset.page === pageId) {
                nav.classList.add('active');
            }
        });
    }

    // --- Data Loading Functions ---
    async function loadAllData(user) {
        loadHomeNotices();
        loadMembers();
        loadDonations();
        loadFinanceData();
        loadBloodDonors();
        if (!user.isAnonymous) {
            loadMyProfile(user.uid);
            loadMyDonations(user.uid);
        }
    }

    async function loadHomeNotices() {
        const container = document.getElementById('homeNoticeBoard');
        try {
            const q = query(collection(db, "notices"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                container.innerHTML = '<p>কোনো নতুন নোটিশ নেই।</p>';
                return;
            }
            container.innerHTML = '';
            snapshot.forEach(doc => {
                const notice = doc.data();
                container.innerHTML += `<div class="data-item"><h4>${notice.title}</h4><p>${notice.details}</p></div>`;
            });
        } catch (error) {
            showError(container, 'নোটিশ লোড করা সম্ভব হয়নি। ফায়ারবেস রুলস চেক করুন।');
        }
    }

    async function loadMembers() {
        const container = document.getElementById('memberList');
        try {
            const snapshot = await getDocs(collection(db, "members"));
            container.innerHTML = '';
            snapshot.forEach(doc => {
                const member = doc.data();
                container.innerHTML += `<div class="data-item">${member.name} - ${member.phone}</div>`;
            });
        } catch (error) {
            showError(container, 'সদস্য তালিকা লোড করা সম্ভব হয়নি।');
        }
    }

    async function loadDonations() {
        const container = document.getElementById('donationList');
        try {
            const snapshot = await getDocs(collection(db, "donations"));
            container.innerHTML = '';
            snapshot.forEach(doc => {
                const d = doc.data();
                container.innerHTML += `<div class="data-item">${d.userName}: ${d.amount} টাকা</div>`;
            });
        } catch (error) {
            showError(container, 'ডোনেশন তালিকা লোড করা সম্ভব হয়নি।');
        }
    }
    
    async function loadFinanceData() {
        const container = document.getElementById('finance-summary');
        try {
            const [donationsSnap, expensesSnap] = await Promise.all([
                getDocs(collection(db, "donations")),
                getDocs(collection(db, "expenses"))
            ]);
            let totalIncome = 0;
            donationsSnap.forEach(doc => totalIncome += Number(doc.data().amount || 0));
            let totalExpense = 0;
            expensesSnap.forEach(doc => totalExpense += Number(doc.data().amount || 0));
            container.innerHTML = `
                <div class="data-item"><strong>মোট আয়:</strong> ${totalIncome.toLocaleString('bn-BD')} টাকা</div>
                <div class="data-item"><strong>মোট ব্যয়:</strong> ${totalExpense.toLocaleString('bn-BD')} টাকা</div>
                <div class="data-item"><strong>বর্তমান ব্যালেন্স:</strong> ${(totalIncome - totalExpense).toLocaleString('bn-BD')} টাকা</div>
            `;
        } catch (error) {
             showError(container, 'আয়-ব্যয় হিসাব লোড করা সম্ভব হয়নি।');
        }
    }
